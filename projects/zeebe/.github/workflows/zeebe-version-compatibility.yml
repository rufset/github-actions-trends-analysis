name: Zeebe Version Compatibility
on:
  workflow_dispatch:
  schedule:
    # Run at 10:00 on every tuesday
    - cron: '0 10 * * 2'
concurrency:
  group: zeebe-version-compatibility
  cancel-in-progress: false

permissions:
  actions: read # Required to get the previous report

jobs:
  rolling-update-tests:
    name: Rolling Update Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shards: [ 1, 2, 3] # Values are not used, we just need an array of the right length
    steps:
      - uses: actions/checkout@v4
      - name: Find previous report
        id: get-last-run-id
        run: |
          runs=$(gh api /repos/camunda/zeebe/actions/workflows/zeebe-version-compatibility.yml/runs)
          last_run_id=$(echo $runs | jq 'first(.workflow_runs[] | select(.status=="completed").id)')
          echo "last_run_id=$last_run_id" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Download previous report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: zeebe-version-compatibility
          path: ${{ github.workspace }}
          run-id: ${{ steps.get-last-run-id.outputs.last_run_id }}
          github-token: ${{ github.token }}
      - uses: ./.github/actions/setup-zeebe
        with:
          secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
          secret_vault_address: ${{ secrets.VAULT_ADDR }}
          secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
      - uses: ./.github/actions/build-zeebe
      - name: Test rolling update
        run: >
          ./mvnw -B --no-snapshot-updates -pl zeebe/qa/update-tests
          -D it.test=io.camunda.zeebe.test.RollingUpdateTest
          -D failsafe.rerunFailingTestsCount=3
          -D skipChecks
          verify
        env:
          ZEEBE_CI_CHECK_VERSION_COMPATIBILITY: true
          ZEEBE_CI_CHECK_VERSION_COMPATIBILITY_INDEX: ${{ strategy.job-index }}
          ZEEBE_CI_CHECK_VERSION_COMPATIBILITY_TOTAL: ${{ strategy.job-total }}
          ZEEBE_CI_CHECK_VERSION_COMPATIBILITY_REPORT: ${{ github.workspace }}/zeebe-version-compatibility
      - uses: ./.github/actions/collect-test-artifacts
        if: always()
        with:
          name: "Version compatibility ${{ strategy.job-index }}"
      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zeebe-version-compatibility-${{ strategy.job-index }}
          path: ${{ github.workspace }}/zeebe-version-compatibility
  update-shared-report:
    name: Update Report
    runs-on: ubuntu-latest
    needs: rolling-update-tests
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          pattern: zeebe-version-compatibility-*
      - name: Merge reports
        run : |
          cat zeebe-version-compatibility-*/** | sort | uniq > ${{ github.workspace }}/zeebe-version-compatibility
          if [ ! -s ${{ github.workspace }}/zeebe-version-compatibility ]; then
            exit 1
          fi
      - name: Upload shared report
        uses: actions/upload-artifact@v4
        with:
          name: zeebe-version-compatibility
          path: ${{ github.workspace }}/zeebe-version-compatibility
